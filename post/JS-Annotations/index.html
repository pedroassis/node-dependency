<html lang="en">
<head>

  
  <meta charset="utf-8">
  <title>JS and Annotations</title>
  <meta name="description" content="JS and Annotations">
  <meta name="author" content="">

  
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="http://node-dependency.pedroassis.com.brcss/fonts.css">
  
  
  <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/pure-min.css">
  

    <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/grids-responsive-min.css">

  <link rel="stylesheet" href="http://node-dependency.pedroassis.com.brcss/custom.css">

  
  
  <link rel="stylesheet" href="http://node-dependency.pedroassis.com.brhighlight/styles/monokai_sublime.css">
  
  <script src="http://node-dependency.pedroassis.com.brhighlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

</head>
<body>


<div class="header pure-g">
    <div class="pure-u-1-24 pure-u-md-5-24"></div>
    <div class="pure-u-11-12 pure-u-md-5-8">
        <div class="desktop pure-menu pure-menu-horizontal nav-menu">
            
            <a href="/" class="site-title pure-menu-heading">Node-Dependency</a>
            <ul class="pure-menu-list">
                
                <li class="pure-menu-item">
                    <a href="http://node-dependency.pedroassis.com.brabout/" class="pure-menu-link">About</a>
                </li>
            </ul>
        </div>
        <div class="mobile pure-menu nav-menu">
            <a href="/" class="pure-menu-heading" id="toggle-home">Node-Dependency</a>
            <a href="#" id="toggle-btn">&#9776;</a>
            <ul class="pure-menu-list" id="toggle-content" style="display:none;">
                
                
                <li class="pure-menu-item">
                    <a href="http://node-dependency.pedroassis.com.brabout" class="pure-menu-link">About</a>
                </li>
            </ul>
        </div>
    </div>
    <div class="pure-u-1-24 pure-u-md-1-6"></div>
</div>


<div class="pure-g">
    <div class="pure-u-1-24 pure-u-md-5-24"></div>
	<div class="pure-u-11-12 pure-u-md-5-8">
        <div class="post">

            <div class="post-title">
                <p class="footnote">
                    <time class="">2015-07-04</time>
		            
                    
                    |
                    
                    
                    tags:<a href="http://node-dependency.pedroassis.com.brtags/javascript">JavaScript</a> <a href="http://node-dependency.pedroassis.com.brtags/use-strict">use strict</a> <a href="http://node-dependency.pedroassis.com.brtags/annotations">annotations</a> <a href="http://node-dependency.pedroassis.com.brtags/es5">ES5</a> <a href="http://node-dependency.pedroassis.com.brtags/esprima">esprima</a> 
                    

                    

                    
                </p>
                <h1>JS and Annotations</h1>
            </div>

            <div class="post-content">
                

<p>Since ECMAScript 5 specification it was introduced the &lsquo;use strict&rsquo; directive, which is used to declared that the code inside the scope of the &lsquo;use strict&rsquo; should use a subset of the JavaScript language.</p>

<hr />

<p>It means that the same code should run different of the same code without it, for instance, you can&rsquo;t declare a global variable in the following way:</p>

<pre><code class="language-js">    someNumber = 123;
</code></pre>

<p>The code above will run in any browser, declaring <code>someNumber</code> in the global scope because of the missing <code>var</code>.</p>

<hr />

<pre><code class="language-js">    'use strict';
    someNumber = 123; // ReferenceError: someNumber is not defined
</code></pre>

<p>The second snippet runs in strict mode and will throw a error on browsers ES5 compatible, because of using a variable that was not defined.</p>

<p>And the same code will run without any problems in all browsers that do not support the ES5 especification.</p>

<p>Recently ASM started using a annotation <code>use asm</code> to define that a code should be run as a fast subset of JS (Pretty fast accually).</p>

<hr />

<h3 id="time-to-use-it-too:d7338891ff065b1ca5fd0fae23813d48">Time to use it too!</h3>

<p>So we already know that annotations exists in JS, they look like code, in fact they are a <code>Literal Expression</code>, but they just get vaccued into the void, not meaning anything to normal JS code.</p>

<h4 id="how-can-we-use-it:d7338891ff065b1ca5fd0fae23813d48">How can we use it?</h4>

<p>Pretty good question, JS does not provide a simple way of using it.
I was going to suggest writing a parser to read the code and detect those annotations.<br />
JS is such a powerful language that you can accually do it.</p>

<p>But this would take a little bit of time, and reading annotations is not what we need right now, we need to use it.</p>

<p>Then I&rsquo;ve found there are a lot of JS parsers out there and I chose <a href="http://esprima.org">Esprima</a> to the job.</p>

<p>Esprima is pretty cool, it reads your JS code and returns a Node Tree with the parsed code.</p>

<p>Let&rsquo;s read the following function and see what we get.</p>

<pre><code class="language-js">function Person(name){};
JSON.stringify(esprima.parse('function Person(name){}'), null, 4) 
// Or JSON.stringify(esprima.parse(Person.toString()), null, 4) 
{
    &quot;type&quot;: &quot;Program&quot;,
    &quot;body&quot;: [
        {
            &quot;type&quot;: &quot;FunctionDeclaration&quot;,
            &quot;id&quot;: {
                &quot;type&quot;: &quot;Identifier&quot;,
                &quot;name&quot;: &quot;Person&quot;
            },
            &quot;params&quot;: [
                {
                    &quot;type&quot;: &quot;Identifier&quot;,
                    &quot;name&quot;: &quot;name&quot;
                }
            ],
            &quot;defaults&quot;: [],
            &quot;body&quot;: {
                &quot;type&quot;: &quot;BlockStatement&quot;,
                &quot;body&quot;: []
            },
            &quot;generator&quot;: false,
            &quot;expression&quot;: false
        }
    ]
}
</code></pre>

<p>Esprima read a bunch of data out of the function.</p>

<p>It has identified that this is a <code>FunctionDeclaration</code>, with name <code>Person</code> and a parameter called <code>name</code>.<br />
And also the <code>body</code> of the function, which is empty.</p>

<p>That&rsquo;s cool! How about this:</p>

<pre><code class="language-js">
var code = &quot;'use strict'&quot; +
           &quot;\n&quot; +
           &quot;function Person(name){}&quot;;

JSON.stringify(esprima.parse(code), null, 4)
{
    &quot;type&quot;: &quot;Program&quot;,
    &quot;body&quot;: [
        {
            &quot;type&quot;: &quot;ExpressionStatement&quot;,
            &quot;expression&quot;: {
                &quot;type&quot;: &quot;Literal&quot;,
                &quot;value&quot;: &quot;use strict&quot;,
                &quot;raw&quot;: &quot;\&quot;use strict\&quot;&quot;
            }
        },
        {
            &quot;type&quot;: &quot;FunctionDeclaration&quot;,
            &quot;id&quot;: {
                &quot;type&quot;: &quot;Identifier&quot;,
                &quot;name&quot;: &quot;Person&quot;
            }
            ...
        }
    ]
}

</code></pre>

<p>Now we can read the annotations from the source code, we can see in the JSON that we have a <code>use strict</code> before our function.</p>

<p>This is how we extract annotations from JS files on <a href="https://github.com/pedroassis/js-annotation-reader">js-annotation-reader</a>, which is the module used by <a href="https://github.com/pedroassis/node-dependency">node-dependency</a> to enable annotation support.</p>

<p>Using this technique I wrote js-annotation-reader, and using it you can read a file like this:</p>

<pre><code class="language-js">'package com.pedro'

'@RequestHandler(&quot;/user&quot;)'
function UserHandler () {
    
    '@Get(&quot;/all&quot;)'
    this.fetchAll = function() {
        return [{
            name : 'USER!'
        }, {
            anotherOne : 1234567
        }];
    };
    
    '@Get(&quot;/id/:id&quot;)'
    this.getByID = function($id) {
        return {
            userID : $id,
            name : &quot;aSDFGHJKL&quot;
        };
    };

}
</code></pre>

<h5 id="and-we-get-this-result:d7338891ff065b1ca5fd0fae23813d48">And we get this result:</h5>

<pre><code class="language-js">{
    &quot;name&quot;: &quot;UserHandler&quot;,
    &quot;packaged&quot;: &quot;com.pedro&quot;,
    &quot;parameters&quot;: [],
    &quot;annotations&quot;: [
        {
            &quot;name&quot;: &quot;RequestHandler&quot;,
            &quot;value&quot;: &quot;/user&quot;,
            &quot;targets&quot;: &quot;UserHandler&quot;
        }
    ],
    &quot;imports&quot;: [],
    &quot;methods&quot;: [
        {
            &quot;annotations&quot;: [
                {
                    &quot;name&quot;: &quot;Get&quot;,
                    &quot;value&quot;: &quot;/all&quot;,
                    &quot;targets&quot;: &quot;fetchAll&quot;
                }
            ],
            &quot;parameters&quot;: [],
            &quot;name&quot;: &quot;fetchAll&quot;
        },
        {
            &quot;annotations&quot;: [
                {
                    &quot;name&quot;: &quot;Get&quot;,
                    &quot;value&quot;: &quot;/id/:id&quot;,
                    &quot;targets&quot;: &quot;getByID&quot;
                }
            ],
            &quot;parameters&quot;: [
                &quot;$id&quot;
            ],
            &quot;name&quot;: &quot;getByID&quot;
        }
    ]
}
</code></pre>

<p>If you are wondering in what this can be used, just check this out <a href="https://github.com/pedroassis/nd-express-plugin">Express Plugin</a></p>

<p>References:</p>

<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Strict_mode#Making_eval_and_arguments_simpler">Mozilla&rsquo;s MDN</a></p>

<p><a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-directive-prologues-and-the-use-strict-directive">ECMAScript 5</a></p>

<p><a href="http://asmjs.org/spec/latest/">ASM.js</a></p>

            </div>

            <div style="margin-bottom: 43px;">
                <div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = '';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            </div>
        </div>
	</div>
    <div class="pure-u-1-24 pure-u-md-1-6"></div>
</div>

<div class="footer pure-g">
    <div class="pure-u-1-24 pure-u-md-5-24"></div>
    <div class="pure-u-11-12 pure-u-md-5-8">
        <div class="pure-menu pure-menu-horizontal footer-content">
            <ul>
                <li class="pure-menu-heading" id="foot-name">:</li>

                

                

                

                

                

            </ul>
            <a href="#" class="pure-menu-heading pull-right" id="gototop-btn">↑↑</a>
        </div>
	  </div>
      <div class="pure-u-1-24 pure-u-md-1-6"></div>
</div>


<script src="http://node-dependency.pedroassis.com.brjs/jquery.min.js" type="text/javascript"></script>
<script src="http://node-dependency.pedroassis.com.brjs/jquery.timeago.js" type="text/javascript"></script>
<script type="text/javascript">
  $(function(){
    $("time.timeago").timeago();
  })
  $("#toggle-btn").click(function(){
    $("#toggle-content").toggle();
    if($(this).html() === "☰") {
        $(this).html("X")
    } else {
        $(this).html("☰")
    }
  });
  $(window).resize(function(){
    if(window.innerWidth > 768) {
      $(".desktop").removeAttr("style");
    }
  });
</script>

</body>
</html>

